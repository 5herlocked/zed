<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Zed Web View â€” Proto Inspector</title>
<style>
  :root {
    --bg: #1e1e2e;
    --surface: #181825;
    --overlay: #313244;
    --text: #cdd6f4;
    --subtext: #a6adc8;
    --blue: #89b4fa;
    --green: #a6e3a1;
    --red: #f38ba8;
    --yellow: #f9e2af;
    --mauve: #cba6f7;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: 'SF Mono', 'Cascadia Code', 'Fira Code', monospace;
    font-size: 13px;
    background: var(--bg);
    color: var(--text);
    height: 100vh;
    display: flex;
    flex-direction: column;
  }
  header {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px 16px;
    background: var(--surface);
    border-bottom: 1px solid var(--overlay);
  }
  header h1 { font-size: 14px; font-weight: 600; color: var(--blue); }
  .controls {
    display: flex;
    gap: 8px;
    align-items: center;
  }
  input {
    background: var(--overlay);
    border: 1px solid var(--subtext);
    color: var(--text);
    padding: 4px 8px;
    border-radius: 4px;
    font-family: inherit;
    font-size: 12px;
    width: 280px;
  }
  button {
    background: var(--blue);
    color: var(--bg);
    border: none;
    padding: 4px 12px;
    border-radius: 4px;
    cursor: pointer;
    font-family: inherit;
    font-size: 12px;
    font-weight: 600;
  }
  button:hover { opacity: 0.9; }
  button.danger { background: var(--red); }
  .status {
    margin-left: auto;
    font-size: 11px;
    color: var(--subtext);
  }
  .status .dot {
    display: inline-block;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    margin-right: 4px;
    background: var(--red);
  }
  .status.connected .dot { background: var(--green); }
  #stats {
    font-size: 11px;
    color: var(--subtext);
    padding: 6px 16px;
    background: var(--surface);
    border-bottom: 1px solid var(--overlay);
    display: flex;
    gap: 16px;
  }
  #stats span { color: var(--yellow); }
  main {
    flex: 1;
    overflow-y: auto;
    padding: 8px 0;
  }
  .msg {
    padding: 3px 16px;
    display: flex;
    gap: 12px;
    font-size: 12px;
    border-bottom: 1px solid transparent;
  }
  .msg:hover { background: var(--overlay); }
  .msg .id { color: var(--subtext); min-width: 50px; }
  .msg .type { color: var(--mauve); min-width: 200px; font-weight: 600; }
  .msg .bytes { color: var(--subtext); min-width: 60px; text-align: right; }
  .msg .summary { color: var(--text); }
  .msg.error .type { color: var(--red); }
  .msg.disconnected .type { color: var(--red); font-style: italic; }
  #empty {
    color: var(--subtext);
    text-align: center;
    padding: 40px;
  }
</style>
</head>
<body>
  <header>
    <h1>Zed Proto Inspector</h1>
    <div class="controls">
      <input id="url" type="text" value="ws://localhost:8080" placeholder="ws://host:port">
      <button id="connectBtn" onclick="doConnect()">Connect</button>
      <button class="danger" onclick="doClear()">Clear</button>
    </div>
    <div class="status" id="status">
      <span class="dot"></span> Disconnected
    </div>
  </header>
  <div id="stats">
    Messages: <span id="msgCount">0</span>
    &nbsp;|&nbsp; Bytes: <span id="byteCount">0</span>
  </div>
  <main id="log">
    <div id="empty">Connect to a Zed remote server to see proto messages</div>
  </main>

  <script type="module">
    import init, { connect_with_callback, launch_file_tree } from './gpui_web.js';

    let msgCount = 0;
    let byteCount = 0;

    window.doConnect = async function() {
      const url = document.getElementById('url').value;
      if (!url) return;

      await init();

      document.getElementById('empty').style.display = 'none';
      setStatus(true);

      connect_with_callback(url, function(jsonStr) {
        const msg = JSON.parse(jsonStr);

        if (msg.type === '_Disconnected') {
          setStatus(false);
          addMessage({ id: '-', type: 'Disconnected', bytes: 0, summary: msg.summary }, 'disconnected');
          return;
        }

        msgCount++;
        byteCount += msg.bytes || 0;
        document.getElementById('msgCount').textContent = msgCount;
        document.getElementById('byteCount').textContent = formatBytes(byteCount);

        const cls = msg.type === 'Error' ? 'error' : '';
        addMessage(msg, cls);
      });
    };

    window.doLaunchTree = async function() {
      const url = document.getElementById('url').value;
      if (!url) return;
      await init();
      launch_file_tree(url);
    };

    window.doClear = function() {
      document.getElementById('log').innerHTML = '';
      msgCount = 0;
      byteCount = 0;
      document.getElementById('msgCount').textContent = '0';
      document.getElementById('byteCount').textContent = '0';
    };

    function setStatus(connected) {
      const el = document.getElementById('status');
      if (connected) {
        el.className = 'status connected';
        el.innerHTML = '<span class="dot"></span> Connected';
      } else {
        el.className = 'status';
        el.innerHTML = '<span class="dot"></span> Disconnected';
      }
    }

    function addMessage(msg, extraClass) {
      const log = document.getElementById('log');
      const div = document.createElement('div');
      div.className = 'msg ' + (extraClass || '');
      div.innerHTML = `
        <span class="id">#${msg.id}</span>
        <span class="type">${msg.type}</span>
        <span class="bytes">${formatBytes(msg.bytes)}</span>
        <span class="summary">${escapeHtml(msg.summary || '')}</span>
      `;
      log.appendChild(div);
      log.scrollTop = log.scrollHeight;
    }

    function formatBytes(b) {
      if (b < 1024) return b + 'B';
      if (b < 1024*1024) return (b/1024).toFixed(1) + 'KB';
      return (b/1024/1024).toFixed(1) + 'MB';
    }

    function escapeHtml(s) {
      return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    }
  </script>
</body>
</html>
